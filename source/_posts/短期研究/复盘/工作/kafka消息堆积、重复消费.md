---
title: _kafka消息堆积、重复消费
date: 2024-07-20 07:56:29
tags: 
categories: 
onlyOneDrive: "false"
---
# 1. 背景（Situation）
**2022.12.07**
工作邮箱不断收到服务模块的业务邮件，业务逻辑就是模块产生消息后，需要发送邮件、短信。测试环境也都出现了用户不算收到重复邮件。

# 2. 任务（Task）
以恢复业务为目的，迅速定位原因并修复

# 3. 行动（Action）
## 3.1 判断问题归属端
1. 判断生产-消费端，哪一端的问题：web页面上取消用户订阅邮件，但是邮件仍然发送，则判断是消费端出现的问题
2. 根据现象，缩小代码范围并排查：观察消息消费，代码逻辑正确，且微服务日志并无报错
## 3.2 猜测重平衡机制，待验证
观察调试时，kafka消息全生命周期，发现kafka消息在固定分区堆积

# 4. 结果（Result）
恢复业务，原因为一次消息需要处理500条数据，导致了session.timeout.ms超时，进而引发了rebalance重平衡，消息不断重复消费且堆积


# 5. 好与坏（Think）
总结这个事情你做的好的方面，与不好的方面

## 5.1 做得好的方面

## 5.2 做得不好的方面