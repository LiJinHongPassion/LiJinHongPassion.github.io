---
title: _复盘：加速场信息架构脱敏
date: 2024-08-07 07:50:51
tags:
  - 复盘/工作/Haydn
categories:
  - 复盘
  - 工作
  - Haydn
onlyOneDrive: "false"
---
# 1. 背景（Situation）

现有需求将单个信息架构沉淀到加速场，并对信息架构的字段进行自定义正则脱敏，1个信息架构包含5类数据：
- 主题设计：400
- 逻辑模型：1w实体 * 3个需要脱敏的字段 + 10w属性 * 3个需要脱敏的字段
- 物理模型：同上
- ETL映射：1000
- 业务指标设计：500
由上述规格，单信息架构单类数据可以看出最大数据量为33w。
当前约束：
- 不允许新增微服务来单独处理脱敏，目前有kafka、mysql、redis可使用
- 已有云服务不允许增加规格配置

# 2. 任务（Task）

1. 设计用户旅程，明确脱敏粒度和脱敏交互流程，梳理业务约束
2. 从可靠性角度，思考如何保证高可用
3. 如何预防ReDos攻击
# 3. 行动（Action）

**分析**
根据单个信息架构的规格数据显示，除了逻辑模型、物理模型，其他类型的数据量不大，则可直接按照分类一次脱敏即可；
模型则按照单模型->单表（或全部、或1k张表）的粒度进行脱敏，具体流程如下：
**逻辑/物理脱敏流程图**
![[Pasted image 20240810094712.png]]
**Java代码脱敏方法时序图**
// todo：待补齐

**信息架构脱敏规格约束清单**

| 类型     | 数量                        |
| ------ | ------------------------- |
| 主题设计   | 400                       |
| 物理模型   | 最多脱敏数量 < 1000张表 and 1w字段  |
| 逻辑模型   | 最多脱敏数量 < 1000个实体 and 1w属性 |
| ETL映射  | 1000                      |
| 业务指标设计 | 500                       |
**正则脱敏规格约束清单**
因为业务的脱敏诉求并不频繁，所以在Kafka消费端执行脱敏操作时使用线程池并将值设置很小，保证资源不会被脱敏业务全部占满，经过测试单模型最大规格最大配置脱敏时间在1分钟左右，具体会根据正则复杂程度浮动。

| 类型    |                                                                              |
| ----- | ---------------------------------------------------------------------------- |
| 脱敏正则  | 50条，每条最长10个字符，每条脱敏数据最多配置10条正则                                                |
| 脱敏时间  | 单数据里单正则<1s，单数据<5s                                                            |
| 脱敏线程池 | 核心线程数：2（服务实例最大CPU=2）<br>最大线程数：10<br>缓存队列数：10<br>过期时间：60s<br>拒绝策略：拒绝接受服务，返回异常 |
**数据清除策略**
脱敏过程中会产生大量的临时数据，长时间不处理，会占用mysql内存

| 类型   |                           |
| ---- | ------------------------- |
| 脱敏报告 | 脱敏成功后，全部软删除<br>每天清除3天前的数据 |
| 脱敏记录 | 保留最近5次                    |

# 4. 结果（Result）

上线无异常，且服务性能无告警
# 5. 好与坏（Think）

## 5.1 做得好的方面

## 5.2 做得不好的方面