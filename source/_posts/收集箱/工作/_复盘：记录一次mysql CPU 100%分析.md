---
title: _复盘：记录一次mysql CPU 100%分析
date: 2024-08-07 07:51:31
tags: 
categories: 
onlyOneDrive: "false"
---
# 1. 背景（Situation）

自动化用例执行期间，MySQL的CPU飙升，95%-100%，导致用例执行速度缓慢，执行了3个小时，2k个用例依然未通过，执行策略是串行，平时大概20分钟执行完成，因为会失败。
# 2. 任务（Task）

定位原因并解决恢复
# 3. 行动（Action）

## 3.1 分析
猜测有可能为一下原因导致：
- 慢SQL
- 数据量大（百万测试数据）
- 内存满了
- 长事务，导致所冲突

**查看测试期间数据库监控看板**
- 内存14.3/16G=89%
- **慢SQL：200～250个/分钟**
- 总连接数：430～480个
- 活跃连接数：10～20个/s
- **QPS：200～4000次/s**
- CPU：95～100%
- **长事务：最长452s**
- 行锁：峰值29个
- MDL锁：40-194个

## 3.2 优化

**慢SQL**
1. 非测试期间，找到慢SQL日志，摘选1条SQL执行，3355ms
2. EXPLAN分析，全表扫描有2处，分别是15w和1w的数据，笛卡尔积15w \* 1w

**长事务 & 锁冲突**
// todo
定时任务存在较长执行时间，最长事务执行452s（这里事务的超时时间和mysql的链接超时时间是多少），并且存在锁等待，1.0几秒。


# 4. 结果（Result）

**慢SQL即使再慢，也不至于无法执行，是什么原因导致用例频繁失败？**
因为触发了服务的熔断

**为什么CPU 100%**
因为用例执行期间正好是晚上11点，有定时任务执行，把MySQL的内存，CPU占满了，导致其他服务抢资源。同时还有部分高频（测试期间，调用次数13K+）慢SQL执行。


# 5. 好与坏（Think）
总结这个事情你做的好的方面，与不好的方面

## 5.1 做得好的方面

## 5.2 做得不好的方面